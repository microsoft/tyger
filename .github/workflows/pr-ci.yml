name: Tyger

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  pull_request:
    branches: [main]

permissions:
      id-token: write
      contents: read

jobs:
  tyger-build-deploy:
      runs-on: ["self-hosted", "1ES.Pool=tyger-gh-1es"]
      container:
        image: compimagdevcontainers.azurecr.io/tyger@sha256:1285398df96fbd37cdc574834e49c7bdb7260f8c98f7aabb3469ac98085f70af
      steps:
        - name: 'Login into Azure'
          uses: azure/login@v1
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

        - name: Checkout
          uses: actions/checkout@v3

        - name: 'Set variables'
          id: set-variables
          run: |
            set -eo pipefail
            event_name="${{ github.event_name }}"
            if [ "$event_name" == "pull_request" ]; then
              environment_name="tyger-pr${{ github.event.pull_request.number }}"
            else
              environment_name="tygerwestus2"
            fi
            tyger_uri=$(TYGER_ENVIRONMENT_NAME="${environment_name}" make -s get-tyger-uri)
            echo "TYGER_ENVIRONMENT_NAME=$environment_name" >> "$GITHUB_OUTPUT"
            echo "TYGER_URI=$tyger_uri" >> "$GITHUB_OUTPUT"
          shell: bash

        - name: 'Build and test'
          run: |
            set -eo pipefail
            az group list
            df -h
            echo "TYGER_ENVIRONMENT_NAME = ${{ steps.set-variables.outputs.TYGER_ENVIRONMENT_NAME }}"
            echo "TYGER_URI = ${{ steps.set-variables.outputs.TYGER_URI }}"
          shell: bash
